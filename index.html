<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDVX MEGAMIX_Memo</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // GoogleAuthProvider に変更
        import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.FirebaseSDK = { initializeApp, getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap');

        body {
            background-color: #1b4332;
            color: #222;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        .pop-card {
            background: white;
            border: 3px solid #000;
            box-shadow: 6px 6px 0px #000;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }
        .pop-card:active {
            transform: translate(3px, 3px);
            box-shadow: 2px 2px 0px #000;
        }
        .pop-card.active {
            border-color: #52b788;
            box-shadow: 6px 6px 0px #52b788;
        }

        .danger-badge {
            position: absolute;
            top: -12px;
            left: 10px;
            padding: 2px 10px;
            border: 2px solid #000;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            z-index: 10;
            box-shadow: 2px 2px 0px #000;
        }
        .danger-badge-1 { background: #ffb703; color: #000; }
        .danger-badge-2 { background: #e63946; color: #fff; }

        .memo-area {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.3s ease-out;
            background: #fdfdfd;
            border-radius: 12px;
            position: relative;
        }
        .memo-area.open {
            max-height: 2000px; 
            opacity: 1;
            margin-top: 12px;
            padding: 12px 12px 10px 12px;
            border: 2px solid #000;
        }

        .filter-area {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .filter-area.show {
            max-height: 1500px;
            opacity: 1;
            margin-top: 1rem;
            padding: 1rem;
            border: 3px solid #000;
            border-radius: 1rem;
            background-color: #ffffff;
        }

        .filter-trigger {
            border: 3px solid #000;
            background: white;
            box-shadow: 4px 4px 0px #000;
            transition: all 0.2s;
        }
        .filter-trigger.is-active {
            background: #40916c;
            color: white;
        }
        .filter-trigger.open {
            background: #40916c;
            color: white;
        }

        .filter-btn {
            border: 2px solid #000;
            box-shadow: 2px 2px 0px #000;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 38px;
            background: white;
        }
        .filter-btn.active {
            background: #52b788;
            color: white;
        }

        .toggle-btn-group {
            display: flex;
            background: #2d6a4f;
            padding: 4px;
            border-radius: 14px;
            border: 2px solid #000;
            gap: 4px;
        }
        .toggle-btn-small {
            flex: 1;
            padding: 8px 4px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 900;
            color: white;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .toggle-btn-small.active {
            background: white;
            color: #1b4332;
            box-shadow: 2px 2px 0px #000;
        }

        .batch-btn {
            border: 1px solid #000;
            padding: 1px 8px;
            border-radius: 6px;
            font-size: 9px;
            background: #f8f8f8;
            transition: all 0.1s;
            font-weight: 900;
            text-transform: uppercase;
        }

        .section-label {
            font-size: 13px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #1b4332;
            text-decoration: underline;
            text-decoration-thickness: 3px;
            text-decoration-color: #52b788;
            text-underline-offset: 4px;
        }

        .stat-box {
            background: white;
            border: 2px solid #000;
            padding: 6px 2px;
            border-radius: 8px;
            text-align: center;
            color: #000;
        }
        .stat-label {
            font-size: 10px;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 3px;
            color: #000;
        }
        .stat-value {
            font-size: 18px;
            font-weight: 900;
            line-height: 1.1;
            color: #000;
        }

        .link-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 12px 6px;
            background: white;
            border: 2px solid #000;
            border-radius: 10px;
            font-weight: 900;
            font-size: 13.5px;
            color: #000;
            transition: all 0.1s;
            box-shadow: 3px 3px 0px #000;
            line-height: 1;
        }
        .link-button:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0px #000;
        }
        .link-button.chart { background: #e9edc9; }
        .link-button.video { background: #fec5bb; }

        .ranking-row {
            background: white;
            border: 2px solid #000;
            box-shadow: 4px 4px 0px #000;
            display: flex;
            align-items: flex-start;
            padding: 10px 12px;
            border-radius: 16px;
            margin-bottom: 10px;
        }
        .rank-number {
            width: 64px; 
            font-size: 20px;
            font-weight: 900;
            font-style: italic;
            color: #132a13;
            flex-shrink: 0;
            padding-top: 2px;
        }
        .rank-1 { color: #ffd700; text-shadow: 2px 2px 0px #000; }
        .rank-2 { color: #c0c0c0; text-shadow: 2px 2px 0px #000; }
        .rank-3 { color: #cd7f32; text-shadow: 2px 2px 0px #000; }

        .nav-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .nav-btn {
            background: white;
            border: 2px solid #000;
            padding: 8px 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 3px 3px 0px #000;
            transition: all 0.2s;
            height: 42px;
            min-width: 60px;
        }
        .nav-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0px #000;
        }

        .dropdown-panel {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            min-width: 220px;
            width: max-content;
            background: white;
            border: 2px solid #000;
            border-radius: 12px;
            box-shadow: 4px 4px 0px #000;
            overflow: hidden;
            z-index: 60;
            animation: dropdownFade 0.2s ease-out;
        }
        @keyframes dropdownFade {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dropdown-item {
            width: 100%;
            text-align: left;
            padding: 14px 20px;
            font-size: 13px;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.1s;
            white-space: nowrap;
        }
        .dropdown-item.active {
            background: #d8f3dc;
            color: #1b4332;
        }

        .pagination-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            padding-bottom: 40px;
        }
        .page-btn {
            background: white;
            border: 2px solid #000;
            box-shadow: 3px 3px 0px #000;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.1s;
        }
        .page-btn:active:not(:disabled) {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0px #000;
        }
        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .page-info {
            background: #2d6a4f;
            color: white;
            padding: 6px 14px;
            border-radius: 10px;
            border: 2px solid #000;
            font-weight: 900;
            font-size: 12px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white;
            border: 4px solid #000;
            box-shadow: 8px 8px 0px #000;
            border-radius: 24px;
            width: 100%;
            max-width: 320px;
            padding: 24px;
            text-align: center;
            animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .hit-counter {
            background: #6b7280; 
            color: white;
            font-size: 11px;
            font-weight: 900;
            padding: 3px 12px;
            border-radius: 99px;
            display: inline-flex;
            align-items: center;
            border: 2px solid #000;
            box-shadow: 2px 2px 0px #000;
        }

        .auth-btn {
            background: white;
            border: 2px solid #000;
            padding: 8px 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 3px 3px 0px #000;
            transition: all 0.2s;
            height: 42px;
            font-weight: 900;
            font-size: 13px;
        }

        .fav-btn {
            background: white;
            border: 2px solid #e5e7eb;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: #d1d5db;
        }
        .fav-btn.active {
            border-color: #fbbf24;
            background: #fffbeb;
            color: #fbbf24;
            box-shadow: 2px 2px 0px #fbbf24;
        }
        
        .memo-textarea {
            width: 100%;
            border: 2px solid #000;
            border-radius: 8px;
            padding: 8px;
            font-size: 13px;
            font-weight: bold;
            resize: vertical;
            min-height: 60px;
            box-shadow: inset 2px 2px 0px rgba(0,0,0,0.05);
            background: #f9fafb;
        }

        .fav-filter-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 12px;
            border-radius: 16px;
            border: 3px solid #000;
            background: white;
            font-weight: 900;
            font-size: 14px;
            box-shadow: 4px 4px 0px #000;
            transition: all 0.2s;
            margin-bottom: 12px;
        }
        .fav-filter-toggle.active {
            background: #fffbeb;
            border-color: #fbbf24;
            color: #b45309;
            box-shadow: 4px 4px 0px #fbbf24;
        }

        .error-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #e63946;
            color: white;
            padding: 14px 24px;
            border: 3px solid black;
            border-radius: 16px;
            box-shadow: 6px 6px 0px black;
            z-index: 1000;
            font-weight: 900;
            font-size: 13px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            animation: toastPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* 起動時・ログイン処理用オーバーレイ */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: #1b4332;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDSa7sQ4L9w894TSK8RPs4-XdFZ28CUEgA",
            authDomain: "sdvx-megamix-memo.firebaseapp.com",
            projectId: "sdvx-megamix-memo",
            storageBucket: "sdvx-megamix-memo.firebasestorage.app",
            messagingSenderId: "808467911876",
            appId: "1:808467911876:web:4b220e81fb99b240532591",
            measurementId: "G-PLYC5FW8QK"
        };

        const GAS_URL = "https://script.google.com/macros/s/AKfycbx7_U9VEerpLL3tKpW8fTAOFnETZFzIdbu2ZTyFRwkHASWIRCFNHZldo24VPL2laIjS3Q/exec";
        const ITEMS_PER_PAGE = 30;
        const APP_ID = "sdvx-megamix-memo";

        const LV17_LIST = ["17.0", "17.5"];
        const LV18_LIST = Array.from({length: 10}, (_, i) => `18.${i}`);
        const LV19_LIST = Array.from({length: 10}, (_, i) => `19.${i}`);
        const LV20_LIST = Array.from({length: 10}, (_, i) => `20.${i}`);

        const formatLevel = (lv) => {
            const lvStr = String(lv || "");
            if (["17", "18", "19", "20"].includes(lvStr)) return lvStr + ".0";
            return lvStr;
        };

        const getBorderColor = (difficult) => {
            const diff = String(difficult || "").toUpperCase();
            switch(diff) {
                case "MXM": return "#000000";
                case "EXH": return "#ef4444";
                case "GRV": return "#d97706";
                case "HVN": return "#0891b2";
                case "INF": return "#f472b6"; 
                case "VVD": return "#ff00ff"; 
                case "XCD": return "#2563eb";
                case "ULT": return "#ffff00"; 
                default: return "#000000";
            }
        };

        // --- Modals ---
        const LinkConfirmModal = ({ isOpen, onConfirm, onCancel, type }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay" onClick={onCancel}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="mb-4">
                            <div className={`w-16 h-16 mx-auto rounded-full flex items-center justify-center mb-4 border-4 border-black ${type === 'video' ? 'bg-[#fec5bb]' : 'bg-[#e9edc9]'}`}>
                                <i className={`ph-bold ${type === 'video' ? 'ph-youtube-logo' : 'ph-file-text'} text-3xl text-black`}></i>
                            </div>
                            <h2 className="text-xl font-black mb-2">確認</h2>
                            <p className="text-sm font-bold text-gray-600 leading-relaxed px-4">外部サイトへ移動してもよろしいですか？</p>
                        </div>
                        <div className="flex flex-col gap-3 mt-8">
                            <button onClick={onConfirm} className="w-full bg-[#52b788] text-white font-black py-4 rounded-xl border-3 border-black shadow-[4px_4px_0px_#000] active:translate-x-1 active:translate-y-1 active:shadow-none transition-all">はい、移動します</button>
                            <button onClick={onCancel} className="w-full bg-gray-100 text-black font-black py-3 rounded-xl border-3 border-black shadow-[3px_3px_0px_#000] active:translate-x-1 active:translate-y-1 active:shadow-none transition-all">いいえ、戻る</button>
                        </div>
                    </div>
                </div>
            );
        };

        const LogoutConfirmModal = ({ isOpen, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay" onClick={onCancel}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="mb-4">
                            <div className="w-16 h-16 mx-auto rounded-full flex items-center justify-center mb-4 border-4 border-black bg-red-100">
                                <i className="ph-bold ph-sign-out text-3xl text-red-600"></i>
                            </div>
                            <h2 className="text-xl font-black mb-2">ログアウト</h2>
                            <p className="text-sm font-bold text-gray-600 leading-relaxed px-4">ログアウトしてもよろしいですか？</p>
                        </div>
                        <div className="flex flex-col gap-3 mt-8">
                            <button onClick={onConfirm} className="w-full bg-red-500 text-white font-black py-4 rounded-xl border-3 border-black shadow-[4px_4px_0px_#000] active:translate-x-1 active:translate-y-1 active:shadow-none transition-all">ログアウトする</button>
                            <button onClick={onCancel} className="w-full bg-gray-100 text-black font-black py-3 rounded-xl border-3 border-black shadow-[3px_3px_0px_#000] active:translate-x-1 active:translate-y-1 active:shadow-none transition-all">キャンセル</button>
                        </div>
                    </div>
                </div>
            );
        };

        const DeleteConfirmModal = ({ isOpen, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay" onClick={onCancel}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="mb-4">
                            <div className="w-16 h-16 mx-auto rounded-full flex items-center justify-center mb-4 border-4 border-black bg-orange-100">
                                <i className="ph-bold ph-trash text-3xl text-orange-600"></i>
                            </div>
                            <h2 className="text-xl font-black mb-2">セトリの削除</h2>
                            <p className="text-sm font-bold text-gray-600 leading-relaxed px-4">このセトリを削除してもよろしいですか？</p>
                        </div>
                        <div className="flex flex-col gap-3 mt-8">
                            <button onClick={onConfirm} className="w-full bg-orange-500 text-white font-black py-4 rounded-xl border-3 border-black shadow-[4px_4px_0px_#000] active:translate-x-1 active:translate-y-1 active:shadow-none transition-all">削除する</button>
                            <button onClick={onCancel} className="w-full bg-gray-100 text-black font-black py-3 rounded-xl border-3 border-black shadow-[3px_3px_0px_#000] active:translate-x-1 active:translate-y-1 active:shadow-none transition-all">キャンセル</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SongCard = ({ song, showDangerBadge, showTips, isLoggedIn, isFavorite, onToggleFavorite, personalMemo, onSavePersonalMemo }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [modalInfo, setModalInfo] = useState({ isOpen: false, url: '', type: '' });
            const [localMemo, setLocalMemo] = useState(personalMemo || "");
            
            useEffect(() => { setLocalMemo(personalMemo || ""); }, [personalMemo]);

            const displayLevel = useMemo(() => formatLevel(song.level), [song.level]);
            const borderColor = useMemo(() => getBorderColor(song.difficult), [song.difficult]);

            const handleLinkClick = (e, url, type) => {
                e.stopPropagation();
                e.preventDefault();
                setModalInfo({ isOpen: true, url, type });
            };

            return (
                <>
                    <div onClick={() => setIsOpen(!isOpen)} className={`pop-card rounded-2xl p-3 mb-4 cursor-pointer ${isOpen ? 'active' : ''}`}>
                        {showDangerBadge && (song.danger_level === "1" || song.danger_level === "2") && (
                            <div className={`danger-badge ${song.danger_level === "1" ? "danger-badge-1" : "danger-badge-2"}`}>
                                {song.danger_level === "1" ? "要警戒" : "危険"}
                            </div>
                        )}
                        <div className="flex items-center gap-4">
                            <div className="flex-shrink-0 w-[72px] h-[72px] relative overflow-hidden rounded-lg">
                                {song.jacket ? (
                                    <img src={song.jacket} className="border-[3px] w-full h-full object-cover rounded-lg" style={{ borderColor }} onError={e => { e.target.onerror = null; e.target.src = 'https://placehold.jp/24/cccccc/ffffff/150x150.png?text=NO+JACKET'; }} />
                                ) : (
                                    <div className="border-[3px] w-full h-full bg-gray-100 flex items-center justify-center rounded-lg" style={{ borderColor }}><i className="ph-bold ph-music-note text-gray-400 text-xl"></i></div>
                                )}
                            </div>
                            <div className="flex-grow min-w-0">
                                <h3 className="text-lg font-black leading-tight mb-1 break-words">{song.title}</h3>
                                <div className="flex flex-wrap items-center gap-x-4 gap-y-0.5">
                                    <div className="flex items-baseline gap-1 font-black text-black leading-none">
                                        <span className="text-[10px] uppercase font-black">Lv</span>
                                        <span className="text-xl tracking-tight leading-none">{displayLevel}</span>
                                    </div>
                                    <div className="flex items-baseline gap-1 font-black text-black leading-none">
                                        <span className="text-[10px] uppercase font-black">BPM</span>
                                        <span className="text-xl tracking-tight leading-none">{song.bpm || "???"}</span>
                                    </div>
                                </div>
                            </div>
                            <div className="flex flex-col items-center gap-2">
                                {isLoggedIn && (
                                    <button onClick={(e) => { e.stopPropagation(); onToggleFavorite(); }} className={`fav-btn ${isFavorite ? 'active' : ''}`}>
                                        <i className={`${isFavorite ? 'ph-fill' : 'ph-bold'} ph-star text-xl`}></i>
                                    </button>
                                )}
                                <div className={`transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`}><i className="ph-bold ph-caret-circle-down text-2xl"></i></div>
                            </div>
                        </div>
                        <div className={`memo-area ${isOpen ? 'open' : ''}`}>
                            <div className="flex items-center mb-2 text-black"><span className="section-label">第1区間</span></div>
                            <div className="grid grid-cols-3 gap-1.5 mb-4">
                                <div className="stat-box"><p className="stat-label">開始位置</p><p className="stat-value">{song.start_pos || "-"}</p></div>
                                <div className="stat-box"><p className="stat-label">終了位置</p><p className="stat-value">{song.end_pos || "-"}</p></div>
                                <div className="stat-box"><p className="stat-label">チェイン数</p><p className="stat-value">{song.combo || "-"}</p></div>
                            </div>
                            <div className="flex items-center mb-2 text-black"><span className="section-label">第2区間</span></div>
                            <div className="grid grid-cols-3 gap-1.5 mb-5">
                                <div className="stat-box"><p className="stat-label">開始位置</p><p className="stat-value">{song.start_pos2 || "-"}</p></div>
                                <div className="stat-box"><p className="stat-label">終了位置</p><p className="stat-value">{song.end_pos2 || "-"}</p></div>
                                <div className="stat-box"><p className="stat-label">チェイン数</p><p className="stat-value">{song.combo2 || "-"}</p></div>
                            </div>
                            <div className="grid grid-cols-2 gap-3 mb-6">
                                <button disabled={!song.site_link} className={`link-button chart ${!song.site_link ? 'opacity-30 grayscale' : ''}`} onClick={(e) => handleLinkClick(e, song.site_link, 'chart')}><i className="ph-bold ph-file-text text-lg"></i>画像で確認</button>
                                <button disabled={!song.movie_link} className={`link-button video ${!song.movie_link ? 'opacity-30 grayscale' : ''}`} onClick={(e) => handleLinkClick(e, song.movie_link, 'video')}><i className="ph-bold ph-youtube-logo text-lg"></i>動画で確認</button>
                            </div>
                            {showTips && (
                                <div className="bg-white border-2 border-black p-4 rounded-xl shadow-inner min-h-[60px] mb-4">
                                    <div className="flex items-center gap-1.5 mb-2 font-black text-[10px] uppercase text-black">
                                        <i className="ph-fill ph-chat-centered-dots text-[#40916c] text-lg"></i><span>Tips</span>
                                    </div>
                                    <p className="text-sm font-bold text-black whitespace-pre-wrap leading-relaxed">{song.memo || "メモはありません"}</p>
                                </div>
                            )}
                            {isLoggedIn && (
                                <div className="mt-4 pt-4 border-t-2 border-gray-100" onClick={e => e.stopPropagation()}>
                                    <div className="flex items-center gap-1.5 mb-2 font-black text-[10px] uppercase text-black"><i className="ph-bold ph-pencil-simple text-blue-500 text-lg"></i><span>自分用メモ</span></div>
                                    <textarea className="memo-textarea" value={localMemo} onChange={(e) => setLocalMemo(e.target.value)} onBlur={() => onSavePersonalMemo(localMemo)} />
                                </div>
                            )}
                        </div>
                    </div>
                    <LinkConfirmModal isOpen={modalInfo.isOpen} onConfirm={() => { window.open(modalInfo.url, '_blank'); setModalInfo({...modalInfo, isOpen: false}); }} onCancel={() => setModalInfo({...modalInfo, isOpen: false})} type={modalInfo.type} />
                </>
            );
        };

        // --- Setlist Manager ---
        const SetlistManager = ({ songs, songMap, setlists, onSave, onDelete, getSongId, formatLevel }) => {
            const [view, setView] = useState("list");
            const [editingSetlist, setEditingSetlist] = useState(null);
            const [selectingSlot, setSelectingSlot] = useState(null);
            const [isSongModalOpen, setIsSongModalOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");
            const [openSetlists, setOpenSetlists] = useState({});
            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
            const [deletingId, setDeletingId] = useState(null);

            if (view === "list") return (
                <div className="flex flex-col gap-4">
                    <div className="flex items-center justify-between mb-2 mt-2">
                        <div className="flex items-center gap-2"><i className="ph-fill ph-list-numbers text-3xl text-[#52b788]"></i><h2 className="text-2xl font-black italic text-white uppercase tracking-tighter">セトリ管理</h2></div>
                        <button onClick={() => { setEditingSetlist({ id: Date.now().toString(), name: "", songs: [null, null, null, null, null] }); setView("edit"); }} className="bg-white text-black font-black py-1.5 px-3 rounded-lg border-2 border-black shadow-[2px_2px_0px_#000] text-xs flex items-center gap-1"><i className="ph-bold ph-plus"></i> 新規</button>
                    </div>
                    {setlists.length === 0 ? (
                        <div className="bg-white/10 p-10 rounded-2xl border border-white/10 text-white text-center"><i className="ph-bold ph-music-notes text-4xl text-white/50 mb-2 block"></i><p className="text-sm font-bold">作成されたセトリがありません</p></div>
                    ) : (
                        <div className="flex flex-col gap-4">
                            {setlists.map((sl, idx) => (
                                <div key={sl.id} className="bg-white border-4 border-black rounded-2xl p-4 shadow-[6px_6px_0px_#000]">
                                    <div className="flex items-center justify-between cursor-pointer" onClick={() => setOpenSetlists(prev => ({ ...prev, [sl.id]: !prev[sl.id] }))}>
                                        <h3 className="text-base font-black">#{idx + 1}　{sl.name}</h3>
                                        <div className={`transition-transform duration-300 ${openSetlists[sl.id] ? 'rotate-180' : ''}`}><i className="ph-bold ph-caret-circle-down text-2xl"></i></div>
                                    </div>
                                    {openSetlists[sl.id] && (
                                        <div className="mt-4 animate-in fade-in zoom-in-95 duration-200">
                                            <div className="flex flex-col gap-2 mb-4">
                                                {sl.songs.map((sid, i) => {
                                                    const s = songMap[sid];
                                                    return s ? (
                                                        <div key={i} className="flex items-center gap-3 bg-gray-50 border-2 border-black rounded-xl p-2">
                                                            <div className="font-black text-gray-400 text-xs w-4">{i+1}</div>
                                                            <img src={s.jacket} className="w-10 h-10 border-2 border-black rounded object-cover" />
                                                            <div className="flex-grow min-w-0"><div className="text-xs font-black truncate">{s.title}</div><div className="text-[10px] font-black text-gray-500">Lv {formatLevel(s.level)} {s.difficult}</div></div>
                                                        </div>
                                                    ) : null;
                                                })}
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => { setEditingSetlist({...sl, songs: [...sl.songs]}); setView("edit"); }} className="flex-1 bg-yellow-400 font-black py-2 rounded-lg border-2 border-black shadow-[2px_2px_0px_#000] text-xs">編集</button>
                                                <button onClick={() => { setDeletingId(sl.id); setIsDeleteModalOpen(true); }} className="flex-1 bg-red-400 text-white font-black py-2 rounded-lg border-2 border-black shadow-[2px_2px_0px_#000] text-xs">削除</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                    <DeleteConfirmModal isOpen={isDeleteModalOpen} onConfirm={() => { onDelete(deletingId); setIsDeleteModalOpen(false); }} onCancel={() => setIsDeleteModalOpen(false)} />
                </div>
            );

            return (
                <div className="bg-white border-4 border-black rounded-3xl p-5 shadow-[8px_8px_0px_#000]">
                    <h3 className="text-xl font-black mb-4 border-b-4 border-[#52b788] pb-1 inline-block">セトリ作成</h3>
                    <div className="mb-6"><label className="block text-xs font-black text-gray-500 mb-1">セトリ名</label><input type="text" value={editingSetlist.name} onChange={e => setEditingSetlist({...editingSetlist, name: e.target.value})} className="w-full bg-gray-50 border-4 border-black rounded-xl py-3 px-4 font-bold focus:outline-none" /></div>
                    <div className="flex flex-col gap-3 mb-8">
                        {editingSetlist.songs.map((sid, i) => {
                            const s = sid ? songMap[sid] : null;
                            return (
                                <div key={i} onClick={() => { setSelectingSlot(i); setSearchTerm(""); setIsSongModalOpen(true); }} className="border-4 border-black rounded-xl p-2 flex items-center bg-white cursor-pointer hover:bg-gray-50 gap-3">
                                    <div className="w-6 h-6 bg-black text-white rounded-full flex items-center justify-center font-black text-xs">{i+1}</div>
                                    {s ? (
                                        <>
                                            <img src={s.jacket} className="w-10 h-10 border-2 border-black rounded object-cover" />
                                            <div className="flex-grow min-w-0"><div className="text-xs font-black truncate">{s.title}</div></div>
                                        </>
                                    ) : <div className="text-gray-300 font-bold text-sm">曲を選択...</div>}
                                </div>
                            );
                        })}
                    </div>
                    <div className="flex gap-3">
                        <button onClick={() => setView("list")} className="flex-1 bg-gray-200 font-black py-3 rounded-xl border-4 border-black shadow-[3px_3px_0px_#000]">戻る</button>
                        <button onClick={() => { onSave(editingSetlist); setView("list"); }} disabled={!editingSetlist.name || editingSetlist.songs.includes(null)} className="flex-1 bg-[#52b788] text-white font-black py-3 rounded-xl border-4 border-black shadow-[3px_3px_0px_#000] disabled:opacity-30">保存</button>
                    </div>
                    {isSongModalOpen && (
                        <div className="modal-overlay" onClick={() => setIsSongModalOpen(false)}>
                            <div className="modal-content h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                                <input type="text" placeholder="検索..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full border-2 border-black rounded-lg p-3 mb-4 font-bold" />
                                <div className="flex-grow overflow-y-auto space-y-2 pr-1 pb-4">
                                    {songs.filter(s => s.title.toLowerCase().includes(searchTerm.toLowerCase())).slice(0, 50).map((s, i) => (
                                        <div key={i} onClick={() => { const ns = [...editingSetlist.songs]; ns[selectingSlot] = getSongId(s); setEditingSetlist({...editingSetlist, songs: ns}); setIsSongModalOpen(false); }} className="flex items-center gap-3 border-2 border-black rounded-lg p-2 bg-white cursor-pointer active:translate-y-0.5">
                                            <img src={s.jacket} className="w-10 h-10 border-2 border-black rounded" />
                                            <div className="text-xs font-black text-left leading-tight">{s.title}</div>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => setIsSongModalOpen(false)} className="mt-4 w-full bg-gray-100 font-black py-3 rounded-xl border-2 border-black">閉じる</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [songs, setSongs] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isInitialAuthCheck, setIsInitialAuthCheck] = useState(true); 
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedLevels, setSelectedLevels] = useState([]); 
            const [dangerFilter, setDangerFilter] = useState("all"); 
            const [sortOrder, setSortOrder] = useState("desc");
            const [rankSection, setRankSection] = useState("section1"); 
            const [isFilterOpen, setIsFilterOpen] = useState(false);
            const [currentPage, setCurrentPage] = useState("main"); 
            const [isNavOpen, setIsNavOpen] = useState(false);
            const [pageIndex, setPageIndex] = useState(1);
            const [isLogoutModalOpen, setIsLogoutModalOpen] = useState(false);

            const [user, setUser] = useState(null);
            const [isAuthProcessing, setIsAuthProcessing] = useState(false);
            const [authError, setAuthError] = useState(null);
            const [favorites, setFavorites] = useState([]); 
            const [personalMemos, setPersonalMemos] = useState({});
            const [setlists, setSetlists] = useState([]);
            const [showOnlyFavorites, setShowOnlyFavorites] = useState(false);
            const [firebase, setFirebase] = useState(null);

            const getSongId = (s) => `${s.title}_${s.difficult}`;
            const songMap = useMemo(() => {
                const map = {};
                songs.forEach(s => map[getSongId(s)] = s);
                return map;
            }, [songs]);

            // Firebase Logic
            useEffect(() => {
                const init = async () => {
                    const { initializeApp, getAuth, onAuthStateChanged, getFirestore, getRedirectResult } = window.FirebaseSDK;
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    setFirebase({ auth, db });

                    try {
                        const result = await getRedirectResult(auth);
                        if (result) console.log("Login Success via Redirect");
                    } catch (e) {
                        console.error("Auth Error:", e);
                        setAuthError("ログイン中にエラーが発生しました。");
                    } finally {
                        setIsInitialAuthCheck(false);
                    }

                    onAuthStateChanged(auth, (u) => {
                        setUser(u);
                        if (!u) { setFavorites([]); setPersonalMemos({}); setSetlists([]); }
                    });
                };

                const timer = setInterval(() => { if (window.FirebaseSDK) { init(); clearInterval(timer); } }, 100);
            }, []);

            // Data Sync
            useEffect(() => {
                if (!user || !firebase) return;
                const { doc, onSnapshot } = window.FirebaseSDK;
                const unsub1 = onSnapshot(doc(firebase.db, 'artifacts', APP_ID, 'users', user.uid, 'profile', 'data'), snap => {
                    if (snap.exists()) { setFavorites(snap.data().favorites || []); setPersonalMemos(snap.data().memos || {}); }
                }, (err) => console.error(err));
                const unsub2 = onSnapshot(doc(firebase.db, 'artifacts', APP_ID, 'users', user.uid, 'setlists', 'data'), snap => {
                    if (snap.exists()) setSetlists(snap.data().items || []);
                }, (err) => console.error(err));
                return () => { unsub1(); unsub2(); };
            }, [user, firebase]);

            useEffect(() => {
                fetch(GAS_URL).then(r => r.json()).then(d => { setSongs(d); setIsLoading(false); });
            }, []);

            useEffect(() => { setPageIndex(1); }, [currentPage, searchTerm, selectedLevels, dangerFilter, sortOrder, rankSection, showOnlyFavorites]);

            const login = async () => {
                if (!firebase) return;
                setIsAuthProcessing(true);
                // GoogleAuthProvider に変更
                const { GoogleAuthProvider, signInWithRedirect } = window.FirebaseSDK;
                const provider = new GoogleAuthProvider();
                // Google のアカウント選択を強制するパラメータに変更
                provider.setCustomParameters({ prompt: 'select_account' });
                try {
                    await signInWithRedirect(firebase.auth, provider);
                } catch (e) {
                    console.error(e);
                    setAuthError("ログイン開始に失敗しました。");
                    setIsAuthProcessing(false);
                }
            };

            const logout = async () => {
                if (!firebase) return;
                await window.FirebaseSDK.signOut(firebase.auth);
                setCurrentPage("main");
                setIsLogoutModalOpen(false);
            };

            const toggleFav = async (sid) => {
                if (!user) return;
                const nf = favorites.includes(sid) ? favorites.filter(id => id !== sid) : [...favorites, sid];
                setFavorites(nf);
                await window.FirebaseSDK.setDoc(window.FirebaseSDK.doc(firebase.db, 'artifacts', APP_ID, 'users', user.uid, 'profile', 'data'), { favorites: nf, memos: personalMemos }, { merge: true });
            };

            const saveMemo = async (sid, m) => {
                if (!user) return;
                const nm = { ...personalMemos, [sid]: m };
                setPersonalMemos(nm);
                await window.FirebaseSDK.setDoc(window.FirebaseSDK.doc(firebase.db, 'artifacts', APP_ID, 'users', user.uid, 'profile', 'data'), { favorites, memos: nm }, { merge: true });
            };

            const saveSet = async (s) => {
                if (!user) return;
                const ni = setlists.find(x => x.id === s.id) ? setlists.map(x => x.id === s.id ? s : x) : [s, ...setlists];
                setSetlists(ni);
                await window.FirebaseSDK.setDoc(window.FirebaseSDK.doc(firebase.db, 'artifacts', APP_ID, 'users', user.uid, 'setlists', 'data'), { items: ni });
            };

            const delSet = async (id) => {
                if (!user) return;
                const ni = setlists.filter(x => x.id !== id);
                setSetlists(ni);
                await window.FirebaseSDK.setDoc(window.FirebaseSDK.doc(firebase.db, 'artifacts', APP_ID, 'users', user.uid, 'setlists', 'data'), { items: ni });
            };

            const allFiltered = useMemo(() => {
                let list = songs.map(s => ({ ...s, _c: parseInt(rankSection === "section1" ? s.combo : s.combo2) || 0 }));
                if (currentPage === "danger") {
                    list = list.filter(s => ["1", "2"].includes(String(s.danger_level)));
                    if (dangerFilter !== "all") list = list.filter(s => String(s.danger_level) === dangerFilter);
                }
                const res = list.filter(s => {
                    const matchLv = selectedLevels.length === 0 || selectedLevels.some(l => {
                        if (["17.0", "18.0", "19.0", "20.0"].includes(l)) return String(s.level).startsWith(l.split('.')[0]);
                        return String(s.level) === l;
                    });
                    const matchFav = !showOnlyFavorites || favorites.includes(getSongId(s));
                    const matchSearch = !searchTerm || s.title.toLowerCase().includes(searchTerm.toLowerCase());
                    return matchLv && matchFav && (currentPage !== "main" || matchSearch);
                });
                if (currentPage === "ranking") res.sort((a,b) => sortOrder === "desc" ? b._c - a._c : a._c - b._c);
                return res;
            }, [songs, currentPage, selectedLevels, showOnlyFavorites, favorites, searchTerm, dangerFilter, rankSection, sortOrder]);

            const paginated = allFiltered.slice((pageIndex-1)*ITEMS_PER_PAGE, pageIndex*ITEMS_PER_PAGE);
            const totalP = Math.ceil(allFiltered.length / ITEMS_PER_PAGE);

            if (isInitialAuthCheck) {
                return (
                    <div className="loading-screen">
                        <div className="w-12 h-12 border-4 border-white/20 border-t-white rounded-full animate-spin"></div>
                        <p className="text-white font-black text-xs uppercase tracking-widest">Checking Auth Status...</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen px-4 py-8 max-w-md mx-auto">
                    {authError && <div className="error-toast" onClick={() => setAuthError(null)}><i className="ph-bold ph-warning-circle text-2xl mb-1"></i><p>{authError}</p></div>}
                    {isAuthProcessing && <div className="loading-screen bg-black/60 backdrop-blur-sm"><div className="w-10 h-10 border-4 border-white/20 border-t-[#52b788] rounded-full animate-spin"></div><p className="text-white font-black text-xs">Processing...</p></div>}

                    <div className="fixed top-4 left-4 z-50">
                        <div className="nav-dropdown">
                            <button onClick={() => setIsNavOpen(!isNavOpen)} className="nav-btn"><i className="ph-bold ph-list text-xl"></i><i className={`ph-bold ph-caret-down text-[10px] transition-transform ${isNavOpen ? 'rotate-180' : ''}`}></i></button>
                            {isNavOpen && (
                                <div className="dropdown-panel" onClick={() => setIsNavOpen(false)}>
                                    <button onClick={() => setCurrentPage("main")} className={`dropdown-item ${currentPage === "main" ? "active" : ""}`}><i className="ph-bold ph-music-notes"></i> メイン</button>
                                    <button onClick={() => setCurrentPage("ranking")} className={`dropdown-item ${currentPage === "ranking" ? "active" : ""}`}><i className="ph-bold ph-trophy"></i> ランキング</button>
                                    <button onClick={() => setCurrentPage("danger")} className={`dropdown-item ${currentPage === "danger" ? "active" : ""}`}><i className="ph-bold ph-warning-octagon"></i> 要注意曲</button>
                                    {user && <><button onClick={() => setCurrentPage("setlist")} className={`dropdown-item ${currentPage === "setlist" ? "active" : ""}`}><i className="ph-bold ph-list-numbers"></i> セトリ管理</button><div className="border-t-2 border-gray-100 my-1"></div><button onClick={() => setIsLogoutModalOpen(true)} className="dropdown-item text-red-600"><i className="ph-bold ph-sign-out"></i> ログアウト</button></>}
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="fixed top-4 right-4 z-50">
                        {user ? (
                            <div className="bg-white border-2 border-black px-3 py-2 rounded-xl shadow-[3px_3px_0px_#000] flex items-center gap-2">
                                {user.photoURL && <img src={user.photoURL} className="w-5 h-5 rounded-full border border-black" />}
                                <div className="flex flex-col leading-none"><span className="text-[9px] font-black truncate max-w-[80px]">{user.displayName}</span><span className="text-[7px] font-bold text-gray-400">ONLINE</span></div>
                            </div>
                        ) : (
                            <button onClick={login} disabled={isAuthProcessing} className="auth-btn"><i className="ph-bold ph-user-circle text-lg text-[#52b788]"></i> ログイン</button>
                        )}
                    </div>

                    <header className="mb-10 text-center pt-8">
                        <div className="inline-block bg-white text-black px-4 py-1 rounded-full text-[10px] font-black uppercase tracking-[0.3em] mb-2 transform -rotate-1">SOUND VOLTEX</div>
                        <h1 className="text-5xl font-black italic tracking-tighter uppercase text-white">MEGAMIX<span className="text-[#52b788]">.</span>MEMO</h1>
                    </header>

                    <main className="pb-20">
                        {isLoading ? <div className="text-center py-20"><div className="w-8 h-8 border-4 border-white/10 border-t-[#52b788] rounded-full animate-spin mx-auto mb-4"></div><p className="text-white/50 text-[10px] font-black uppercase">Loading...</p></div> : (
                            <>
                                {currentPage === "setlist" ? <SetlistManager songs={songs} songMap={songMap} setlists={setlists} onSave={saveSet} onDelete={delSet} getSongId={getSongId} formatLevel={formatLevel} /> : (
                                    <div className="space-y-6">
                                        <div className="px-1 flex flex-col gap-3">
                                            {currentPage === "main" && (
                                                <>
                                                    <div className="relative"><input type="text" placeholder="曲名で検索..." className="w-full bg-white border-4 border-black rounded-xl py-4 px-5 font-bold shadow-[4px_4px_0px_#000]" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /><i className="ph-bold ph-magnifying-glass absolute right-4 top-1/2 -translate-y-1/2 text-xl text-gray-300"></i></div>
                                                    {user && <button onClick={() => setShowOnlyFavorites(!showOnlyFavorites)} className={`fav-filter-toggle ${showOnlyFavorites ? 'active' : ''}`}>{showOnlyFavorites ? "★ お気に入りのみ" : "☆ 全曲表示中"}</button>}
                                                </>
                                            )}
                                            {currentPage === "ranking" && (
                                                <div className="toggle-btn-group"><button onClick={() => setRankSection("section1")} className={`toggle-btn-small ${rankSection === "section1" ? 'active' : ''}`}>第1区間</button><button onClick={() => setRankSection("section2")} className={`toggle-btn-small ${rankSection === "section2" ? 'active' : ''}`}>第2区間</button></div>
                                            )}
                                            <button onClick={() => setIsFilterOpen(!isFilterOpen)} className="filter-trigger flex items-center justify-between w-full py-3 px-6 rounded-2xl text-[10px] font-black uppercase tracking-widest"><span>LEVEL FILTER</span><i className={`ph-bold ${isFilterOpen ? 'ph-caret-up' : 'ph-caret-down'}`}></i></button>
                                            <div className={`filter-area ${isFilterOpen ? 'show' : ''}`}>
                                                <div className="grid grid-cols-4 gap-2">
                                                    {["17.0","17.5","18.0","18.1","18.2","18.3","18.4","18.5","19.0","19.1","19.2","19.3","19.4","19.5","20.0"].map(lv => (
                                                        <button key={lv} onClick={() => setSelectedLevels(p => p.includes(lv) ? p.filter(x => x!==lv) : [...p, lv])} className={`filter-btn text-[10px] rounded-lg p-2 font-black ${selectedLevels.includes(lv) ? "active" : ""}`}>{lv}</button>
                                                    ))}
                                                    <button onClick={() => setSelectedLevels([])} className="col-span-4 bg-gray-100 text-[10px] font-black p-2 rounded-lg mt-2">リセット</button>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="space-y-4">
                                            {paginated.map((s, i) => {
                                                if (currentPage === "ranking") {
                                                    const rank = (pageIndex-1)*ITEMS_PER_PAGE + i + 1;
                                                    return (
                                                        <div key={i} className="ranking-row">
                                                            <div className={`rank-number ${rank <= 3 ? `rank-${rank}` : ''}`}>#{rank}</div>
                                                            <div className="flex-grow min-w-0 px-2"><p className="text-sm font-black truncate">{s.title}</p><p className="text-[10px] font-bold text-gray-500">Lv {formatLevel(s.level)} {s.difficult}</p></div>
                                                            <div className="text-right flex-shrink-0"><span className="text-xl font-black">{s._c}</span><span className="text-[8px] font-black ml-1">CHAIN</span></div>
                                                        </div>
                                                    );
                                                }
                                                const sid = getSongId(s);
                                                return <SongCard key={i} song={s} showDangerBadge={currentPage === "danger"} showTips={currentPage === "danger"} isLoggedIn={!!user} isFavorite={favorites.includes(sid)} onToggleFavorite={() => toggleFav(sid)} personalMemo={personalMemos[sid]} onSavePersonalMemo={m => saveMemo(sid, m)} />;
                                            })}
                                        </div>

                                        {totalP > 1 && (
                                            <div className="pagination-container">
                                                <button onClick={() => { setPageIndex(p => p-1); window.scrollTo(0,0); }} disabled={pageIndex === 1} className="page-btn"><i className="ph-bold ph-caret-left"></i></button>
                                                <div className="page-info">{pageIndex} / {totalP}</div>
                                                <button onClick={() => { setPageIndex(p => p+1); window.scrollTo(0,0); }} disabled={pageIndex === totalP} className="page-btn"><i className="ph-bold ph-caret-right"></i></button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </>
                        )}
                    </main>

                    <LogoutConfirmModal isOpen={isLogoutModalOpen} onConfirm={logout} onCancel={() => setIsLogoutModalOpen(false)} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>